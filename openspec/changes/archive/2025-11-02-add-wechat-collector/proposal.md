# Proposal: add-wechat-collector

## Overview
为 AI 新闻采集器添加微信公众号文章采集功能,支持通过**公众号后台接口**方式获取指定公众号的文章列表和详细内容。

**核心技术**: 利用微信公众号后台的文章搜索功能(用于写文章时引用其他公众号文章),通过 `/cgi-bin/appmsgpublish` 接口获取文章数据。此方案相比传统协议抓包方式具有更低的使用门槛和更长的参数有效期。

## Problem Statement
当前系统只支持 AIBase 和知识星球两个数据源,无法采集微信公众号的 AI 相关文章。微信公众号是国内重要的 AI 资讯发布平台,许多优质的 AI 内容和技术文章都首发于公众号。用户需要能够:

1. 采集指定微信公众号的文章列表
2. 获取文章的标题、摘要、发布时间、链接等基本信息
3. (可选) 获取文章的阅读数、点赞数等统计数据
4. 将微信公众号内容与其他数据源统一进行 LLM 评分和过滤

## Stakeholders
- **主要用户**: AI 资讯收集者,需要从多个渠道(包括微信公众号)汇总 AI 新闻
- **技术维护者**: 需要理解公众号后台接口的使用方式
- **合规审查者**: 需要确保采集行为符合微信平台规范和法律要求

**用户前提**: 用户需要拥有一个微信公众号账号(个人订阅号即可,无需认证)

## Related Capabilities
此变更引入一个新的能力:
- `wechat-scraping`: 微信公众号文章采集能力

此能力与现有的 `data-collection` 规格相关,遵循相同的采集器接口规范。

## Out of Scope
以下内容明确**不在**本次变更范围内:

1. **自有公众号 API**: 不实现基于微信公众平台官方素材管理 API 的采集(需要认证公众号)
2. **评论采集**: 不采集文章评论内容
3. **全文抓取**: 不抓取文章完整 HTML 内容,仅获取标题、摘要等元数据
4. **第三方服务集成**: 不集成任何第三方微信数据服务
5. **Web UI**: 不提供完整的 Web 界面,仅提供二维码登录页面

## Success Criteria
1. **功能完整性**:
   - 用户可以通过配置文件指定要采集的公众号列表
   - 系统能成功采集指定公众号的文章列表(至少最新 10-20 篇)
   - 采集的数据能正确转换为 NewsItem 模型

2. **可靠性**:
   - Cookie 过期时能给出清晰的错误提示
   - 采集失败不影响其他数据源的正常工作
   - 实现了基础的频率控制避免被封禁

3. **可维护性**:
   - 提供清晰的配置文档和 token 获取指南
   - 代码遵循现有的 BaseCollector 模式
   - 配置参数(token, fakeid)可通过环境变量或配置文件管理

4. **合规性**:
   - 文档中明确说明此方式仅供个人学习和研究使用
   - 建议用户在采集前获得内容发布者的许可
   - 实现适当的频率控制,避免对微信服务器造成过大压力

## Risks and Mitigations

### 风险 1: 接口变化导致采集失败
- **严重程度**: 中
- **可能性**: 低
- **分析**: 公众号后台接口相对稳定,因为是微信官方功能的一部分
- **缓解措施**:
  - 在文档中说明接口可能随微信版本更新而变化
  - 提供参数更新指南
  - 降级策略:接口失效时跳过微信采集,不影响其他数据源

### 风险 2: 账号被限制
- **严重程度**: 中
- **可能性**: 低
- **分析**: 使用官方后台接口,不易被识别为异常行为
- **缓解措施**:
  - 实现适当的频率控制(建议每次采集间隔 3-5 秒)
  - 在文档中说明合理使用频率
  - 建议使用个人订阅号,避免用重要公众号

### 风险 3: 需要公众号账号门槛
- **严重程度**: 低
- **可能性**: 高
- **分析**: 用户需要拥有公众号账号才能使用此功能
- **缓解措施**:
  - 在文档中说明个人订阅号即可,注册简单
  - 提供详细的注册和登录指南
  - 在启动时检测配置,给出清晰提示

### 风险 4: Token 泄露
- **严重程度**: 高
- **可能性**: 低
- **缓解措施**:
  - Token 必须通过环境变量(.env)配置
  - .env 文件已加入 .gitignore
  - 在文档中提醒用户保护好个人 Token
  - Token 有效期较长但会过期,定期更新

### 风险 5: 法律和合规问题
- **严重程度**: 高
- **可能性**: 低
- **缓解措施**:
  - 在代码和文档中明确标注"仅供学习研究使用"
  - 提供合规使用指南
  - 建议用户遵守微信平台服务条款
  - 不支持大规模商业化采集

## Implementation Strategy
采用**一步到位**策略,基于 wechat-article-exporter 项目的核心技术,直接实现二维码登录:

### Phase 1: 完整实现 (包含二维码登录)
**核心目标**: 实现二维码扫码登录 + 公众号后台接口采集

**技术方案**:
1. **二维码登录流程**:
   - 调用 `/cgi-bin/bizlogin?action=startlogin` 获取二维码
   - 在终端或浏览器中显示二维码
   - 轮询检查登录状态 (`action=ask`)
   - 登录成功后自动获取 token 和 cookie
   - 将 token 持久化保存到本地配置

2. **文章采集流程**:
   - 使用保存的 token 调用 `/cgi-bin/appmsgpublish` 接口
   - 解析多层嵌套的 JSON 响应数据
   - 转换为 NewsItem 模型
   - 支持配置多个公众号

3. **Token 管理**:
   - 检测 token 过期(ret=200003)
   - 自动提示用户重新扫码登录
   - 可选:实现自动刷新(如果微信支持)

**优势**:
- 零配置: 无需手动获取任何参数
- 用户友好: 扫码即用,类似微信网页版
- 自动化: token 自动获取和管理
- 接口稳定: 使用微信官方后台功能

**文件清单**:
- `src/services/wechat-login.js` - 二维码登录服务
- `src/collectors/wechat-mp.js` - 公众号后台接口采集器
- `src/config/datasources.js` - 添加 WECHAT_MP_CONFIG
- `src/utils/qrcode-display.js` - 二维码显示工具
- `src/storage/token-store.js` - Token 本地存储
- `docs/wechat-mp-guide.md` - 使用指南

### Phase 2: 增强功能 (可选)
- 支持关键词搜索文章
- 获取文章统计数据(需额外 credentials)
- 实现文章去重功能
- 提供 Web UI 的二维码登录页面

## Open Questions
以下问题需要在实施前明确:

1. **Q1**: 二维码显示方式?
   - **选项 A**: 在终端显示 ASCII 二维码(qrcode-terminal)
   - **选项 B**: 自动打开浏览器显示二维码
   - **选项 C**: 两种方式都支持,优先终端,失败时打开浏览器
   - **建议**: 选择 C,提供最佳用户体验

2. **Q2**: Token 存储位置?
   - **选项 A**: 存储在项目根目录 `.wechat-token.json`
   - **选项 B**: 存储在用户主目录 `~/.ai-news-collector/wechat-token.json`
   - **建议**: 选择 A,便于项目隔离,但需加入 .gitignore

3. **Q3**: 是否需要在第一阶段就支持多个公众号?
   - **建议**: 支持,配置结构参考知识星球的 accounts 数组
   - **原因**: 用户可能需要同时采集多个 AI 相关公众号

4. **Q4**: Fakeid 如何获取?
   - **方案 A**: 提供搜索公众号功能,用户输入公众号名称获取 fakeid
   - **方案 B**: 用户登录后,自动显示已关注公众号列表供选择
   - **建议**: 优先实现 B,更自动化

5. **Q5**: Token 过期后的处理?
   - **建议**: 检测到 ret=200003 时,自动触发重新登录流程
   - **实现**: 显示二维码让用户重新扫码,无需重启程序

## Dependencies
- **代码依赖**:
  - `axios`: 已存在,用于 HTTP 请求
  - `qrcode-terminal`: 新增,用于在终端显示二维码
  - `qrcode`: 新增,用于生成二维码图片(可选,浏览器显示方式)

- **外部依赖**:
  - 用户需要拥有微信公众号账号(个人订阅号即可,无需认证)
  - 用户需要微信扫一扫功能(手机微信)
  - 微信公众号后台接口保持稳定

- **配置依赖**:
  - 不需要环境变量(token 自动获取)
  - 需要本地文件存储 token (`.wechat-token.json`)
  - 配置文件中需要配置公众号列表(fakeid 和名称)

## Timeline
- **Phase 1 - 二维码登录**: 4-5 小时
  - 实现登录接口调用(startlogin, ask, login)
  - 实现二维码显示(终端 + 浏览器)
  - 实现登录状态轮询
  - 实现 token 持久化存储
  - 处理登录失败和超时

- **Phase 1 - 文章采集**: 3-4 小时
  - 创建 WeChatMPCollector 类
  - 实现 `/cgi-bin/appmsgpublish` 接口调用
  - 实现多层 JSON 解析逻辑
  - Token 过期检测和重新登录

- **Phase 1 - 集成和测试**: 2-3 小时
  - 集成登录和采集流程
  - 测试完整的用户体验
  - 验证多公众号配置
  - 完善错误处理和日志

- **Documentation**: 1-2 小时
  - 编写使用文档
  - 提供二维码登录截图
  - 说明常见问题

- **Total Estimate**: 10-14 小时

## Acceptance Criteria

### 二维码登录功能
- [ ] 实现了 WeChatLoginService 类
- [ ] 能成功获取并显示二维码(终端或浏览器)
- [ ] 能正确轮询登录状态
- [ ] 登录成功后能自动获取 token 和 cookie
- [ ] Token 能持久化存储到本地文件
- [ ] 登录超时有清晰提示
- [ ] Token 文件已加入 .gitignore

### 文章采集功能
- [ ] WeChatMPCollector 类已创建并继承自 BaseCollector
- [ ] 能使用存储的 token 调用 `/cgi-bin/appmsgpublish` 接口
- [ ] 能正确解析多层嵌套的 JSON 响应(publish_page → publish_info → appmsgex)
- [ ] 能成功采集指定公众号的文章列表(至少10篇)
- [ ] 采集的文章能通过 NewsItem 验证
- [ ] 支持配置多个公众号

### Token 过期处理
- [ ] 能检测到 token 过期(ret=200003)
- [ ] Token 过期时自动触发重新登录流程
- [ ] 重新登录无需重启程序

### 配置和文档
- [ ] 微信数据源已添加到 datasources.js (WECHAT_MP_CONFIG)
- [ ] package.json 已添加 qrcode-terminal 依赖
- [ ] 提供了详细的使用指南文档(带二维码登录截图)
- [ ] 所有测试通过(如适用)
- [ ] openspec validate 通过
- [ ] 已标注法律风险和合规提示
- [ ] 文档中说明需要公众号账号的前提条件
- [ ] 说明二维码登录的步骤和注意事项
